<!DOCTYPE html>
<html lang="en">
  <head>
    <title>CTI Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="p-4">
    <h2>IOC Lookup</h2>
    <form method="POST">
      <input
        type="text"
        name="ioc"
        class="form-control"
        placeholder="Enter IP / Domain / URL / Hash"
        required
      />
      <textarea
        name="notes"
        class="form-control mt-2"
        placeholder="Add analyst notes..."
      ></textarea>
      <button class="btn btn-primary mt-2">Submit</button>
    </form>

    {% if result %}
    <h4 class="mt-4">Result</h4>
    <pre class="bg-light p-3 border">{{ result | tojson(indent=2) }}</pre>
    {% endif %}

    <h4 class="mt-4">Visualizations</h4>
    <canvas id="scoreChart" width="400" height="200"></canvas>
    <canvas id="typePieChart" width="400" height="200" class="mt-4"></canvas>

    <script>
      const rawResult = {{ result | tojson | safe }};
      if (rawResult && !rawResult.error) {
        const scoreStats = rawResult.score || {};
        const scoreLabels = Object.keys(scoreStats);
        const scoreValues = Object.values(scoreStats);

        new Chart(document.getElementById("scoreChart"), {
          type: "bar",
          data: {
            labels: scoreLabels,
            datasets: [{
              label: "Threat Score by Engine",
              data: scoreValues,
              backgroundColor: "#dc3545"
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: "Threat Score Breakdown" }
            }
          }
        });

        new Chart(document.getElementById("typePieChart"), {
          type: "pie",
          data: {
            labels: [rawResult.type || "unknown"],
            datasets: [{
              label: "IOC Type",
              data: [1],
              backgroundColor: ["#0d6efd"]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: "IOC Type Distribution" }
            }
          }
        });
      }
    </script>
  </body>
</html>
